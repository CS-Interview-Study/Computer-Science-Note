# 가상 메모리

- 메모리 관리 기법의 하나
- 컴퓨터가 실제로 이용 가능한 메모리 자원을 추상화
- 프로세스 전체가 메모리에 올라와 있지 않아도 실행 가능하도록 한다.
- 물리적 메모리보다 커도 된다.
- 가상 주소는 메모리관리장치(MMU)에 의해 실제 주소로 매핑, 변환된다.
- 프로그래머는 실제 주소를 의식하지 않고 프로그램을 구축할 수 있다.

## 스와핑과 페이지 폴트

- 페이지 폴트
    - 가상 메모리에는 존재하지만 실제 메모리(RAM)에 현재 없는 정보에 접근할 경우 페이지 발생
    - 페이지 폴트가 발생하면 스와핑이 발생한다.
    - 페이지 폴트가 일어나면 CPU 이용률이 낮아진다.
- 스와핑
    - 당장 사용하지 않는 영역을 하드디스크로 옮기고 하드디스크의 일부를 메모리처럼 불러와 사용하는 것
    - 이를 통해 페이지 폴트가 일어나지 않은 것처럼 만든다.
- 발생 순서
    1. 명령어가 유효한 가상 주소에 접근했으나 해당 페이지가 없다면 트랩(trap)이 발생되어 운영체제에 알린다.
    2. 운영체제는 실제 디스크로부터 사용하지 않은 프레임을 찾는다.
    3. 해당 프레임을 실제 메모리에 가져와 페이지 교체 알고리즘을 통해 특정 페이지와 교체한다. (스와핑)
    4. 페이지 테이블을 갱신시킨 후 해당 명령어를 다시 실행한다.

- 페이지
    - 가상 메모리를 사용하는 최소 크기 단위
- 프레임
    - 실제 메모리를 사용하는 최소 크기 단위

# 스레싱

- 메모리의 페이지 폴트율이 높은 것을 의미
- 심각한 성능 저하를 초래
- 메모리에 너무 많은 프로세스가 동시에 올라가면 스와핑이 많이 일어나서 발생
- 페이지 폴트로 인해 CPU 이용률이 낮아지면 CPU 가용성을 높이기 위해 메모리에 더 많은 프로세스를 올리게 된다. 이러한 악순환으로 스레싱이 발생한다.
- 해결 방법
    - 메모리를 늘린다.
    - HDD를 SSD로 바꾼다.
    - 운영체제에서 해결하는 방법으로는 작업세트와 PFF가 있다.

## 작업 세트

- 지역성(프로세스의 과거 사용 이력)을 통해 결정된 페이지 집합을 만들어 미리 메모리에 로드한다.
- 탐색 비용을 줄이고, 스와핑도 줄일 수 있다.

## PFF

Page Fault Frequency

- 페이지 폴트의 빈도를 조절하는 방법으로 상한선과 하한성을 만드는 방법이다.
- 상한선에 도달하면 프레임을 늘리고, 하한선에 도달하면 프레임을 줄이는 방법

# 메모리 할당

## 연속 할당

- 메모리에 공간을 연속적으로 할당
- 고정 분할 방식과 가변 분할 방식으로 나뉜다.

### 고정 분할 방식

- 메모리를 미리 나눠 관리하는 방식
- 미리 나뉘어져 있기 때문에 융통성이 없다.
- 내부 단편화 발생

### 가변 분할 방식

- 매 시점 크기에 맞게 동적으로 메모리를 나눠 관리하는 방식
- 외부 단편화 발생
- 종류
    - 최초적합
        - 위쪽이나 아래쪽부터 시작해서 홀을 찾으면 바로 할당
    - 최적적합
        - 프로세스의 크기 이상인 공간 중 가장 작은 홀부터 할당
    - 최악적합
        - 프로세스의 크기와 가장 많이 차이가 나는 홀에 할당

- 내부 단편화
    - 메모리를 나눈 크기보다 프로그램이 작아서 들어가지 못하는 공간이 많이 발생하는 현상
- 외부 단편화
    - 메모리를 나눈 크기보다 프로그램이 커서 들어가지 못하는 공간이 많이 발생하는 현상
    - 100MB를 55MB, 45MB로 나눴지만 프로그램의 크기가 70MB일 때 들어가지 못 함
- 홀
    - 할당할 수 있는 비어있는 메모리 공간

## 불연속 할당

### 페이징

- 동일한 크기의 페이지 단위로 나눠 서로 다른 위치에 프로세스를 할당
- 홀의 크기가 균일
- 주소 변환이 복잡

### 세그멘테이션

- 페이지 단위가 아닌 의미 단위의 세그먼트로 나누는 방식
- 메모리는 코드 영역, 데이터 영역, 스택 영역, 힙 영역으로 나뉘는데 이러한 방식을 의미
- 공유와 보안 측면에서 장점
- 홀 크기가 균일하지 않다는 단점

### 페이지드 세그멘테이션

- 의미 단위의 세그먼트로 나눠 공유나 보안에 강점을 두고 동일한 크기의 페이지 단위로 나누는 방식

# 페이지 교체 알고리즘

한정적인 메모리로 스와핑이 많이 일어나는데 이를 방지하기 위한 설계로 페이지 교체 알고리즘을 사용한다.

## 오프라인 알고리즘

- 미래에 참조되는 페이지와 현재 할당하는 페이지를 바꾸는 알고리즘
- 가장 좋은 방법이지만 미래에 참조되는 페이지를 알 방법이 없기 때문에 성능 비교의 상한 기준으로 사용한다.

## FIFO

가장 먼저 온 페이지를 교체 영역에 가장 먼저 놓는 방법

## LRU

- 참조가 가장 오래된 페이지를 교체한다.
- 계수와 스택을 두어야 한다는 단점이 있다.

![image](https://github.com/user-attachments/assets/011130eb-7759-4849-86e2-62828c122f82)

### NUR

- LRU에서 발전한 형태의 알고리즘으로 clock 알고리즘이라고도 부른다.
- 접근 비트와 변경 비트를 사용하여 이용 대상 페이지를 선정
- 읽기, 실행 연산시 접근 비트 1로 변경
- 쓰기, 추가 연산시 변경 비트 1로 변경
- 모든 비트가 (1, 1)이면 모두 (0, 0)으로 변경

## LFU

- 가장 참조 횟수가 적은 페이지를 교체한다.
