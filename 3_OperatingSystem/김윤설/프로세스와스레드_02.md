## 프로그램 vs 프로세스 vs 스레드

- **프로그램 (Program)**
    - 실행 가능한 명령어의 집합
    - 보조기억장치에 실행 가능한 파일(이진 파일) 형태로 저장
    - 실행(주기억장치에 적재) 시 프로세스가 됨
- **프로세스 (Process)**
    - 실행 중인 프로그램의 인스턴스
    - 독립적인 메모리 공간을 가지며 운영체제가 관리
- **스레드 (Thread)**
    - 프로세스 내에서 실행되는 실행 흐름의 단위
    - 프로세스의 자원을 공유

## 프로그램 실행 과정

1. **프로그램 로드:**
    - 실행 가능한 파일(바이너리 형식)을 디스크에서 메모리(RAM)로 로드
    - 운영체제는 프로그램의 코드, 데이터, BSS(초기화되지 않은 전역 변수), 스택 등을 할당
2. **프로세스 생성:**
    - 운영체제가 해당 프로그램을 실행하기 위한 프로세스를 생성
    - 운영체제는 프로세스 관리 블록(Process Control Block, PCB)로 프로세스를 추적
        - 프로세스의 상태, 레지스터 값, 메모리 할당 정보 등을 저장
3. **프로세스 초기화:**
    - 프로세스의 초기 상태 설정
    - 프로그램 카운터(Program Counter, PC) 설정, 스택 포인터(Stack Pointer, SP) 등의 레지스터 초기화
4. **프로세스 실행:**
    - 프로세스가 실행 가능한 상태가 되면, 운영체제의 스케줄러에 의해 CPU에 할당
    - 프로그램 카운터가 가리키는 명령어부터 실행 시작
5. **프로세스 종료:**
    - 운영체제가 프로세스 자원 해제, 메모리 반환 -> 프로세스의 종료 상태와 결과를 기록

## 3.3.3 프로세스의 메모리 구조

- 운영체제는 다음 구조를 기반으로 프로세스에 적절한 메모리를 할당
- 동적 영역
    - **스택(stack)**
        - 위 주소부터 할당
        - 지역변수, 매개변수, 함수가 저장
        - 컴파일 시 크기 결정
    - **힙(heap)**
        - 아래 주소부터 할당
        - 런타임 시 크기 결정
- 정적 영역
    - **데이터 영역(BSS Segment, Data Segment)**
        - BSS(Block Started by Symbol) 영역
            - 초기화가 되지 않은 변수가 0으로 초기화되어 저장
            - 전역 변수, 정적 변수
        - Data 영역
            - 0이 아닌 다른 값으로 할당된 변수들이 저장
    - **코드 영역(code segment)**
        - 프로그램의 소스 코드(기계어) 저장
        - Read-Only

> BSS 영역과 Data 영역을 나누어 저장하는 이유?
초기화되지 않은 변수의 메모리 할당을 최소화하고, 실행 시 초기화 비용을 절약하기 위함
> 

## 3.3.4 PCB

### PCB

PCB(Process Control Block, 프로세스 제어 블록)

- 운영체제에서 프로세스에 대한 메타데이터를 저장한 '데이터'

### 특징

- 프로세스 생성 시 운영체제가 해당 PCB 생성 (1프로세스당 1PCB)
- 프로세스의 메타데이터가 PCB에 저장
- 커널 스택의 가장 앞부분에서 관리

> 메타 데이터(Meta Data)
> 
> - 데이터에 관한 구조화된 데이터이자 데이터를 설명하는 작은 데이터
> - 대량의 정보 중 필요한 정보를 효율적으로 사용하기 위해 일정한 규칙에 따라 컨텐츠마다 부여

> 사용자 스택 vs 커널 스택
> 
> - 사용자 스택(User Stack): 사용자 프로세스나 스레드가 사용하는 스택
> - 커널 스택(Kernel Stack): 운영체제 커널이 실행될 때 사용하는 스택

### 구조

| 종류 | 내용 |
| --- | --- |
| 프로세스 ID | 프로세스 ID, 해당 프로세스의 자식 프로세스 ID |
| 프로세스 상태 | Ready, Running, Blocked, Terminated, Created 등 |
| 프로그램 카운터 | 실행할 할 다음 명령어의 주소에 대한 포인터 |
| 프로세스 권한 | 컴퓨터 자원 또는 I/O 디바이스에 대한 정보 |
| CPU 레지스터 | 프로세스 동작을 위한 레지스터 정보 |
| CPU 스케줄링 정보 | 우선 순위, CPU 점유 시간, 최종 실행 시각 등 |
| 계정 정보 | 프로세스 실행에 사용된 CPU 사용량과 실행한 유저 정보 |
| I/O 상태 정보 | 프로세스에 할당된 I/O 디바이스 목록 |
| (* PCB는 연결 리스트로 관리) |  |

### Process Table

- 운영체제는 **프로세스 테이블**로 프로세스별 PCB를 관리
- 커널 메모리에 저장

### Context Switching

### Context

- 프로세스의 데이터
- CPU 레지스터 값

### Context Switching

= 현재 실행 중인 프로세스/스레드에서 다른 프로세스/스레드로 전환하는 과정
= 실행한 프로세스 정보를 PCB에 저장하고, 실행할 프로세스 정보를 PCB에서 불러와 CPU 레지스터에 적재하는 과정

### 목적

- 멀티 태스킹
- 인터럽트 핸들링
- 사용자 <-> 커널모드 전환

### 실행 시점

- 인터럽트(Interrupt)
    - 하드웨어 인터럽트
        - 하드웨어 장치에서 발생하는 인터럽트
        - 입출력 인터럽트 (I/O interrupt)
            - 입출력 작업의 종료나 입출력 오류에 의해 CPU의 기능이 요청됨
        - 정전,전원 이상 인터럽트(Power fail interrupt)
        - 기계 착오 인터럽트(Machine check interrupt)
            - CPU 오류
        - 외부 신호 인터럽트(External interrupt)
            - 타이머 인터럽트(프로세스 time-out) 등
    - 소프트웨어 인터럽트(= 내부 인터럽트)
        - 실행 중인 프로그램에 의해 발생하는 인터럽트
        - 예외(Exception)
            - 프로그램 실행 도중 오류나 예외로 인해 발생하는 인터럽트
            - 예: 0으로 나누기, 잘못된 명령어 사용, 페이지 폴트 등
        - 시스템 호출 (System Call)
            - 사용자 프로그램이 운영체제의 서비스를 호출하기 위해 발생시키는 인터럽트

### 과정

- 인터럽트나 트랩에 의해 컨텍스트 스위칭 요청 발생
- PCB에 프로세스 정보 저장
- 실행할 프로세스 정보를 PCB에서 가져와 CPU 레지스터에 할당

예시:

- 싱글 코어 CPU에서 특정 시점에 실행되는 프로세스는 1개
- A 실행 -> (중단) -> A의 PCB 저장 -> B PCB 로드 > B 실행
- > B의 PCB 저장 -> A의 PCB 로드 ...

### 비용

- **스케줄링 오버헤드**
    - 운영체제가 다음에 어떤 프로세스/스레드를 실행할지 결정
- **레지스터 상태 저장 및 복원**
    - 현재 실행 중인 프로세스나 스레드의 레지스터 상태를 저장
    - 프로그램 카운터(PC), 스택 포인터(SP), 범용 레지스터 등을 저장
- **메모리 상태 저장 및 복원**
    - 현재 프로세스나 스레드의 메모리 상태를 저장
    - 스택, 힙, 데이터 세그먼트, 코드 세그먼트 등의 상태를 저장하는 작업
- **커널 모드로의 전환**
    - 특권 명령을 수행하기 위한 상태 전환
    - 사용자 모드에서 커널 모드로 전환하는 오버헤드
- **캐시의 손실**
    - 현재 실행 중인 프로세스/스레드의 데이터나 명령어가 CPU 캐시에 저장되어 있을 수 있음 -> 캐시 무효화(초기화)
- **TLB(Template Lookaside Buffer)의 리셋**
    - 가상 메모리 시스템에서 사용되는 TLB도 새로운 프로세스의 페이지 테이블로 초기화
- **페이지 테이블 업데이트**
    - 프로세스마다 다른 페이지 테이블을 사용

> 특권 명령(Privileged Instruction)
> 
> - 컴퓨터 시스템에서 운영체제와 같이 특별한 권한을 갖는 소프트웨어가 실행할 수 있는 명령어
> - 필요성
>     - 운영체제가 하드웨어 관리, 프로세스 권한 분리, 시스템 안전성 보장하기 위해 사용
> - 특징
>     - 시스템 레벨의 작업을 수행
>     - 커널 모드에서만 실행 가능
>     - 하드웨어 제어, 메모리 관리, 입출력, 시스템콜

### 스레드에서의 컨텍스트 스위칭

- 스레드는 스택 영역을 제외한 모든 메모리를 공유
- 비용이 더 적고 시간도 더 적게 걸림

> 유휴 시간 (Idle Time)
> 
> - 현재 실행 중인 프로세스/스레드가 중단되고 새로운 프로세스/스레드가 실행될 때까지의 시간
> - CPU가 작업을 수행하지 않는~~(놀고 있는)~~ 시간
