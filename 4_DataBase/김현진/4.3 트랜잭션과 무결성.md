# Section 3 | 트랜잭션과 무결성

## 3.1 ) 트랜잭션

= DBMS가 데이터를 다루는 논리적인 작업의 단위

- **정의하는 이유?**
    
    장애 발생시 데이터 복구하는 작업의 단위
    
    여러 작업이 동시에 같은 데이터를 다룰 때 이 작업을 서로 분리하는 단위
    

데이터베이스에 접근하는 방법은 쿼리이므로, 여러 개의 쿼리들을 하나로 묶는 단위를 말함

원자성, 일관성, 독립성, 지속성 (ACID) 특징

### 원자성(atomicity)

= all or nothing

- 트랜잭션과 관련된 일이 모두 수행되었거나 되지 않았거나를 보장하는 특징

EX) 트랜잭션을 커밋했는데, 문제가 발생하여 롤백하는 경우 그 이후에 모두 수행되지 않음을 보장

- **회복 관리자 프로그램** 사용
    - 데이터베이스가 변경한 내용을 로그로 기록하고 있다가 트랜잭션에 문제가 생겼을 때 원래 상태로 되돌림
- 트랜잭션 단위로 여러 로직들을 묶을 때 외부 API를 호출하는 것이 있으면 안됨
    
    → 만약 있다면 롤백이 일어났을 때 어떻게 해야 할 것인지에 대한 해결 방법 필요
    
    → 트랜잭션 전파 신경써서 관리
    

> **커밋(Commit)**
여러 쿼리가 성공적으로 처리되었다고 확정하는 명령어
트랜잭션 단위로 수행
변경된 내용이 모두 영구적으로 저장되는 것
커밋이 수행 되었다 = 하나의 트랜잭션이 성공적으로 수행되었다
> 

> **롤백(Roll back)**
에러나 여러 이슈들로 인해 트랜잭션으로 처리한 하나의 묶음 과정을 일어나기 전으로 돌리는 일
> 

➡️ 커밋과 롤백 덕에 데이터의 무결성 보장

➡️ 데이터 변경 전에 변경 사항을 쉽게 확인 가능

➡️ 해당 작업 그룹화 가능

> **트랜잭션 전파**
트랜잭션을 수행할 때 커넥션 단위로 수행 - 커넥션 객체를 넘겨서 수행해야 함 - 이를 매번 넘겨주기 어렵고 귀찮음 - 매번 넘겨서 수행하지 않고 여러 트랜잭션 관련 메서드 호출을 하나의 트랜잭션에 묶이도록 하는 것
> 

### 일관성(consistency)

트랜잭션을 수행하기 전 후, 모두 데이터베이스는 항상 일관된 상태를 유지해야 함 

- 테이블이 생성될 때 **CREATE 문과 ALTER문의 무결성 제약조건**을 통해 일관성을 유지
    - 트랜잭션 간에 간섭으로 일관성이 깨지는 현상은 무결셩제약조건으로 해결 불가 → **동시성 제어 알고리즘 필요**

데이터베이스에 기록된 모든 데이터는 여러가지 조건, 규칙에 따라 유효함을 가져야 함

### 격리성(Isolation)

트랜잭션 수행 시 서로 끼어들지 못하는 것

![image](https://github.com/user-attachments/assets/ae79dc43-dfe7-4bb4-9074-f7c817597bc6)


**동시성 제어 알고리즘** 사용

### +) 격리 수준에 따라 발생하는 현상

- **팬텀 리드(Phantom Read)**
    
    한 트랜잭션 내에서 동일한 쿼리를 보냈을 때 해당 조회 결과가 다른 경우
    
    A가 데이터 읽고, B가 데이터를 쓰고(Insert), A가 다시 읽었을 때 이전에 없던 유령 데이터가 나타나는 현상 
    
    → B가 commit 을 했기 때문에 틀린 데이터는 아니지만 같은 SQL 문이 다른 결과를 도출
    
- **반복 불가능 읽기
(non- repeatable read)**
    
    한 트랜잭션 내의 같은 행에 두 번 이상 조회가 발생했는데, 그 값이 다른 경우 
    
    한 트랜잭션이 읽기 작업을 반복할 경우 이전의 결과가 반복되지 않는 현상
    
    → B가 commit 을 했기 때문에 틀린 데이터는 아니지만 같은 SQL 문이 다른 결과를 도출
    
    팬텀 리드와 다른 점은 반복 가능하지 않은 조회는 행 값이 달라질 수도 있는데, 팬텀 리드는 다른 행이 선택될 수도 있다는 것을 의미
    
- **더티 리드(dirty read)**
    
    한 트랜잭션이 실행 중일 때 다른 트랜잭션에 의해 수정되었지만, 아직 커밋되지 않은 행의 데이터를 읽을 수 있을 때 발생
    
    Ex) 읽기 작업을 하는 A가 쓰기 작업을 하는 B의 중간 데이터를 읽었을 때, 작업 중인 B가 어떤 이유로 작업을 롤백할 경우, A는 무효화된 데이터를 읽게 됨 
    

### +) 트랜잭션 고립 수준 명령어

- **Serializable
(더티 리드X, 반복불가능읽기X, 팬텀리드X)**
    
    실행 중인 트랜잭션은 다른 트랜잭션으로부터 완벽하게 분리
    
    → 교착상태가 일어날 확률도 많고 가장 성능이 떨어지는 격리 수준
    
- **Repeatable_read
(더티 리드X, 반복불가능읽기X)**
    
    하나의 트랜잭션이 수정한 행을 다른 트랜잭션이 수정할 수 없도록 막아주지만,
    
    새로운 행을 추가하는 것은 막지 않음
    
    → 이후에 추가된 행이 발견될 수 있음
    
    MySQL 8.0 의 innoDB 기본값
    
- **Read_committed
(더티 리드X)**
    
    가장 많이 사용되는 격리 수준
    
    PostgreSQL, SQL Server, 오라클에서 기본값으로 설정되어 있음
    
    다른 트랜잭션이 커밋하지 않은 정보는 읽을 수 없음(커밋 완료된 데이터만 조회 허용)
    
    어떤 트랜잭션이 접근한 행을 다른 트랜잭션이 수정 가능
    
    → 트랜잭션 A가 같은 행을 다시 읽을 때 다른 내용이 발견될 수 있음
    
- **Read_uncommited**
    
    고립수준이 가장 낮은 명령어
    
    하나의 트랜잭션이 커밋되기 이전에 다른 트랜잭션에 노출되는 문제
    
    가장 빠름
    
    데이터 무결성을 위해 되도록이면 사용하지 않는 것이 이상적
    
    몇몇 행이 제대로 조회되지 않더라도 괜찮은 거대한 양의 데이터를 어림잡아 집계하는 데에 사용하면 좋음
    

### 지속성(durability)

성공적으로 수행된 트랜잭션은 변경한 데이터를 영구히 저장해야 함

데이터베이스에 시스템 장애가 발생해도 원래 상태로 복구하는 회복 기능이 있어야 함을 뜻함

**회복 관리자 프로그램**을 이용

이를 위해 체크섬, 저널링, 롤백 등의 기능 제공

> **체크섬**
중복 검사의 한 형태로 오류 정정을 통해 송신된 자료의 무결성을 보호하는 단순한 방법

로그를 이용해도 어느 시점까지 되돌아가야 하는지 알 수 없음 - 몇 십 분 단위로 데이터베이스와 로그 파일을 동기화한 후, 그 시점을 로그 파일에 기록해두는 방법
> 

> **저널링**
파일 시스템 또는 데이터베이스 시스템에 변경 사항을 커밋하기 전에 로깅하는 것
트랜잭션 등 변경 사항에 대한 로그를 남기는 것
> 

<details>
  <summary> 🐬동시성 제어 </summary>
  트랜잭션이 동시에 실행될 때, 일관성을 해치지 않도록 트랜잭션의 데이터 접근을 제어하는 DBMS의 기능

### 락(Lock)

트랜잭션이 데이터를 읽거나 수정할 때 데이터에 표시하는 **잠금장치**

락은 트랜잭션이 다루는 데이터를 다른 트랜잭션이 접근하지 못하도록 막아 대기 상태로 만듦

→ 사용자의 응답시간에 영향 → 가능한 최소화 해야 함

### 데드락(Deadlock, 교착상태)

두 개 이상의 트랜잭션이 각각 자신의 데이터에 대하여 락을 획득하고

상대방 데이터에 대하여 락을 요청

→ 무한 대기 상태 발생

</details>




## 무결성

데이터의 **정확성, 일관성, 유효성**을 유지하는 것

→ 일관성과 정확성을 가지고 구축된 데이터베이스가 계속해서 무결성을 유지하려면, 투플의 삽입, 삭제, 수정 시 데이터의 제약조건 준수 여부를 확인해야 함 

### 개체 무결성(기본키 제약)

기본키로 선택된 필드는  NULL 값을 허용하지 않음

릴레이션 내에 오직 하나의 값만 존재해야 함 

### 참조 무결성(외래키 제약)

서로 참조 관계에 있는 두 테이블의 데이터는 항상 일관된 값 유지

### 고유 무결성(도메인 무결성, 도메인 제약)

특정 속성에 대해 고유한 값을 가지도록 조건이 주어진 경우 그 속성 값은 모두 고유한 값을 가짐

릴레이션 내의 투플들이 각 속성의 도메인에 지정된 값만 가져야 함

### NULL 무결성

특정 속성 값에 NULL이 올 수 없다는 조건이 주어진 경우 그 속성 값은 NULL이 될 수 없다는 제약 조건
